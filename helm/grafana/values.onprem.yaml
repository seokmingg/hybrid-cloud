# üì¶ helm/grafana/values.onprem.yaml

replicaCount: 1

sidecar:
  alerts:
    enabled: true
    label: grafana_alert

admin:
  existingSecret: grafana-admin
  userKey: admin-user
  passwordKey: admin-password


persistence:
  enabled: true
  storageClassName: nfs-storage
  accessModes:
    - ReadWriteOnce
  size: 5Gi

service:
  type: ClusterIP
  port: 80
  annotations:
    networking.istio.io/exportTo: "*"

ingress:
  enabled: false  # Istio Gateway ÏÇ¨Ïö©ÌïòÎØÄÎ°ú ingressÎäî ÎÅî

resources:
  requests:
    memory: 256Mi
    cpu: 250m
  limits:
    memory: 512Mi
    cpu: 500m

datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        url: http://prometheus-operated.monitoring.svc:9090
        access: proxy
        isDefault: true

alerting:
  enabled: true
  configmap:
    name: grafana-alerting
    data:
      alerting.yaml: |
        apiVersion: 1
        groups:
          - orgId: 1
            name: cpu
            folder: system
            interval: 1m
            rules:
              - uid: aei0b86ch9ts0b
                title: node_cpu_seconds_total
                condition: C
                data:
                  - refId: A
                    relativeTimeRange:
                      from: 300
                      to: 0
                    datasourceUid: fehyowlpd8ruof
                    model:
                      disableTextWrap: false
                      editorMode: builder
                      expr: instance:node_cpu:ratio
                      fullMetaSearch: false
                      includeNullMetadata: true
                      instant: true
                      intervalMs: 1000
                      legendFormat: __auto
                      maxDataPoints: 43200
                      range: false
                      refId: A
                      useBackend: false
                  - refId: C
                    datasourceUid: __expr__
                    model:
                      conditions:
                        - evaluator:
                            params:
                              - 0.9
                            type: gt
                          operator:
                            type: and
                          query:
                            params:
                              - C
                          reducer:
                            params: []
                            type: last
                          type: query
                      datasource:
                        type: __expr__
                        uid: __expr__
                      expression: A
                      intervalMs: 1000
                      maxDataPoints: 43200
                      refId: C
                      type: threshold
                noDataState: NoData
                execErrState: Error
                for: 1m
                annotations:
                  description: CPU ÏÇ¨Ïö©Î•†Ïù¥ 90% Ï¥àÍ≥º Ïãú ÏïåÎ¶º Î∞úÏÉù
                  summary: "ÎÖ∏ÎìúCPUÏÇ¨Ïö©Î•†{{ `{{ $labels.instance }}` }}"
                isPaused: false
                notification_settings:
                  receiver: slack
          - orgId: 1
            name: disk
            folder: system
            interval: 1m
            rules:
              - uid: fei0i280ln8jka
                title: master-node-filesystem /
                condition: D
                data:
                  - refId: A
                    relativeTimeRange:
                      from: 300
                      to: 0
                    datasourceUid: fehyowlpd8ruof
                    model:
                      disableTextWrap: false
                      editorMode: builder
                      expr: node_filesystem_size_bytes{fstype!~"tmpfs|overlay", instance="192.168.0.100:9100", mountpoint="/", device="/dev/mapper/ubuntu--vg-ubuntu--lv"}
                      fullMetaSearch: false
                      includeNullMetadata: true
                      instant: true
                      intervalMs: 1000
                      legendFormat: __auto
                      maxDataPoints: 43200
                      range: false
                      refId: A
                      useBackend: false
                  - refId: B
                    relativeTimeRange:
                      from: 300
                      to: 0
                    datasourceUid: fehyowlpd8ruof
                    model:
                      datasource:
                        type: prometheus
                        uid: fehyowlpd8ruof
                      disableTextWrap: false
                      editorMode: builder
                      expr: node_filesystem_avail_bytes{fstype!~"tmpfs|overlay", instance="192.168.0.100:9100", mountpoint="/", device="/dev/mapper/ubuntu--vg-ubuntu--lv"}
                      fullMetaSearch: false
                      includeNullMetadata: true
                      instant: true
                      intervalMs: 1000
                      legendFormat: __auto
                      maxDataPoints: 43200
                      range: false
                      refId: B
                      useBackend: false
                  - refId: C
                    datasourceUid: __expr__
                    model:
                      conditions:
                        - evaluator:
                            params:
                              - 0
                              - 0
                            type: gt
                          operator:
                            type: and
                          query:
                            params: []
                          reducer:
                            params: []
                            type: avg
                          type: query
                      datasource:
                        name: Expression
                        type: __expr__
                        uid: __expr__
                      expression: 100*($A-$B)/$A
                      intervalMs: 1000
                      maxDataPoints: 43200
                      refId: C
                      type: math
                  - refId: D
                    datasourceUid: __expr__
                    model:
                      conditions:
                        - evaluator:
                            params:
                              - 90
                              - 0
                            type: gt
                          operator:
                            type: and
                          query:
                            params: []
                          reducer:
                            params: []
                            type: avg
                          type: query
                      datasource:
                        name: Expression
                        type: __expr__
                        uid: __expr__
                      expression: C
                      intervalMs: 1000
                      maxDataPoints: 43200
                      refId: D
                      type: threshold
                noDataState: NoData
                execErrState: Error
                annotations:
                  description: ÏÇ¨Ïö©Î•† 90%Ï¥àÍ≥º
                  summary: "ÎîîÏä§ÌÅ¨ ÏÇ¨Ïö©Î•† Í≤ΩÍ≥†: {{ `{{ $labels.instance }}` }} ({{ `{{ $labels.mountpoint }}` }})"
                isPaused: false
                notification_settings:
                  receiver: slack
          - orgId: 1
            name: memory
            folder: system
            interval: 1m
            rules:
              - uid: bei0blr52hclcf
                title: node-memory
                condition: C
                data:
                  - refId: A
                    relativeTimeRange:
                      from: 300
                      to: 0
                    datasourceUid: fehyowlpd8ruof
                    model:
                      disableTextWrap: false
                      editorMode: builder
                      expr: instance:node_memory_utilisation:ratio
                      fullMetaSearch: false
                      includeNullMetadata: true
                      instant: true
                      intervalMs: 1000
                      legendFormat: __auto
                      maxDataPoints: 43200
                      range: false
                      refId: A
                      useBackend: false
                  - refId: C
                    datasourceUid: __expr__
                    model:
                      conditions:
                        - evaluator:
                            params:
                              - 0.95
                            type: gt
                          operator:
                            type: and
                          query:
                            params:
                              - C
                          reducer:
                            params: []
                            type: last
                          type: query
                      datasource:
                        type: __expr__
                        uid: __expr__
                      expression: A
                      intervalMs: 1000
                      maxDataPoints: 43200
                      refId: C
                      type: threshold
                noDataState: NoData
                execErrState: Error
                for: 1m
                annotations:
                  description: Î©îÎ™®Î¶¨95%ÎÑòÏñ¥Í∞ÄÎ©¥ÏïåÎûå
                  summary: "ÎÖ∏ÎìúÎ©îÎ™®Î¶¨ÏÇ¨Ïö©Î•†{{ `{{ $labels.instance }}` }}"
                isPaused: false
                notification_settings:
                  receiver: slack

