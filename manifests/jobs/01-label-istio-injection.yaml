apiVersion: v1
kind: Namespace
metadata:
  name: job
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: istio-labeler
  namespace: job
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: istio-labeler-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin # ìµœì†Œ ê¶Œí•œìœ¼ë¡œ ì¡°ì • ê°€ëŠ¥
subjects:
  - kind: ServiceAccount
    name: istio-labeler
    namespace: job
---
apiVersion: batch/v1
kind: Job
metadata:
  name: label-istio-injection
  namespace: job
  labels:
    app.kubernetes.io/name: istio-injection-job
spec:
  ttlSecondsAfterFinished: 60
  template:
    spec:
      serviceAccountName: istio-labeler
      containers:
        - name: kubectl
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              echo "ğŸ‘‰ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¼ë²¨ ì¶”ê°€ ì¤‘..."
              kubectl label namespace argocd istio-injection=enabled --overwrite  || true
              kubectl label namespace harbor istio-injection=enabled --overwrite  || true
              kubectl label namespace monitoring istio-injection=enabled --overwrite  || true

              echo "ğŸ”„ Deployment ë¡¤ì•„ì›ƒ ì¤‘..."
              kubectl rollout restart deploy -n argocd argocd-server  || true
              kubectl rollout restart deploy -n harbor harbor-core  || true
              kubectl rollout restart deploy -n harbor portal  || true 
              kubectl rollout restart deploy -n harbor jobservice  || true
              kubectl rollout restart deploy -n monitoring grafana  || true
      restartPolicy: OnFailure