apiVersion: batch/v1
kind: Job
metadata:
  name: label-istio-injection
  namespace: istio-system
  labels:
    app.kubernetes.io/name: istio-injection-job
spec:
  template:
    spec:
      containers:
        - name: kubectl
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              echo "👉 네임스페이스 라벨 추가 중..."
              kubectl label namespace argocd istio-injection=enabled --overwrite
              kubectl label namespace harbor istio-injection=enabled --overwrite
              kubectl label namespace monitoring istio-injection=enabled --overwrite

              echo "🔄 Deployment 롤아웃 중..."
              kubectl rollout restart deploy -n argocd argocd-server
              kubectl rollout restart deploy -n harbor harbor-core
              kubectl rollout restart deploy -n harbor portal
              kubectl rollout restart deploy -n harbor jobservice
              kubectl rollout restart deploy -n monitoring grafana
      restartPolicy: OnFailure